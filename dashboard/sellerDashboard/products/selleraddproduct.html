<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Product</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f6f2e7;
    }

    .container {
      max-width: 700px;
    }

    .card {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .addproduct {
      background-color: #b69d6f;
      border: none;
      transition: 0.3s;
    }

    .addproduct:hover {
      background-color: #d2b667;
      box-shadow: 2px 2px 2px black;
      scale: 1.02;
    }
  </style>
</head>

<body>
  <div class="container py-5">
    <div class="card p-4">
      <h2 class="mb-4" style="color: #a0804d;"><i class="fa-solid fa-plus" style="color: #b69d6f;"></i>Add New Product
      </h2>

      <form id="addProductForm" autocomplete="off">
        <div class="mb-3">
          <label class="form-label">Product Name</label>
          <input type="text" id="productName" class="form-control" required />
        </div>

        <div class="mb-3">
          <label class="form-label">Price (EGP)</label>
          <input type="number" id="productPrice" class="form-control" required min="0" step="0.01" />
        </div>

        <div class="mb-3">
          <label class="form-label">Stock</label>
          <input type="number" id="productStock" class="form-control" required min="0" step="1" />
        </div>

        <div class="mb-3">
          <label class="form-label">Category</label>
          <select id="productCategory" class="form-select" required>
            <option value="Living Room">Living Room</option>
            <option value="Bedroom">Bedroom</option>
            <option value="Dining Room">Dining Room</option>
            <option value="Office">Office</option>
            <option value="Outdoor">Outdoor</option>
            <option value="Lighting & Decor">Lighting & Decor</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Image (filename or full URL)</label>
          <input type="text" id="productImage" class="form-control"
            placeholder="e.g. sofa-rose.jpg or https://.../img.jpg" required />
          <div class="form-text">
            If you enter a filename only (e.g. <code>sofa-rose.jpg</code>), it
            will be read from your <code>assets/</code> folder.
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100 addproduct">
          Add Product
        </button>
      </form>

      <div id="message" class="mt-3 fw-bold"></div>
    </div>
  </div>

  <script>
    // --- Helpers ---
    function readLS(key, fallback) {
      try {
        const v = JSON.parse(localStorage.getItem(key));
        return v ?? fallback;
      } catch {
        return fallback;
      }
    }
    function writeLS(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

    // Generate next ID like p073, p074... from existing products in LS
    function generateNewProductId() {
      const products = readLS("products", []);
      let maxNum = 0;

      for (const p of products) {
        if (!p?.id) continue;
        const m = /^p(\d+)$/.exec(p.id);
        if (m) {
          const n = parseInt(m[1], 10);
          if (!Number.isNaN(n) && n > maxNum) maxNum = n;
        }
      }
      const next = maxNum + 1;
      return "p" + String(next).padStart(3, "0");
    }

    // Normalize image value:
    // - If it starts with http(s) or a slash or contains '/', keep as-is.
    // - If it's just a filename, we'll store it as filename and renderers can prefix with assets/.
    function normalizeImageInput(raw) {
      const val = raw.trim();
      if (!val) return "";
      if (/^https?:\/\//i.test(val)) return val; // full URL
      if (val.startsWith("/") || val.includes("/")) return val; // relative path given
      return val; // filename only; renderers should handle prefix
    }

    document
      .getElementById("addProductForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();

        const currentUser = readLS("currentUser", null);
        if (!currentUser || currentUser.role !== "seller") {
          alert("You must be logged in as a seller to add products.");
          return;
        }

        const name = document.getElementById("productName").value.trim();
        const price = parseFloat(
          document.getElementById("productPrice").value
        );
        const stock = parseInt(
          document.getElementById("productStock").value,
          10
        );
        const category = document.getElementById("productCategory").value;
        const imageRaw = document.getElementById("productImage").value;
        const img = normalizeImageInput(imageRaw);

        const newProduct = {
          id: generateNewProductId(),
          name,
          price,
          stock,
          category,
          images: [img],
          sellerId: currentUser.id,
          currency: "EGP",
          description: "", // optional
          rating: 0 // ðŸ‘ˆ default rating so it wonâ€™t be null
        };

        // Save into products
        const products = readLS("products", []);
        products.push(newProduct);
        writeLS("products", products);

        // Also add the product id to the seller's record
        const users = readLS("users", []);
        const idx = users.findIndex((u) => u.id === currentUser.id);
        if (idx !== -1) {
          users[idx].products = users[idx].products || [];
          if (!users[idx].products.includes(newProduct.id)) {
            users[idx].products.push(newProduct.id);
          }
          writeLS("users", users);
        }

        const msg = document.getElementById("message");
        msg.classList.remove("text-danger");
        msg.classList.add("text-success");
        msg.textContent = `âœ… Product ${newProduct.id} added successfully!`;
        window.location.href = "sellerproducts.html";
        this.reset();
      });
  </script>
</body>


</html>
