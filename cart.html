<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shopping Cart</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
      integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      /* Breadcrumb */
      .breadcrumb-nav {
        margin: 20px auto 30px;
        max-width: 1100px;
        font-size: 14px;
        color: #666;
      }
      .breadcrumb-nav a {
        text-decoration: none;
        color: gray;
        font-weight: 500;
      }
      .breadcrumb-nav a:hover {
        text-decoration: underline;
      }
      .breadcrumb-nav span {
        margin: 0 5px;
      }
      .breadcrumb-nav .active {
        color: black;
        font-weight: 600;
      }
      nav a.navbar-brand {
        color: black;
      }

  .table thead th {
        background-color: #a0804d !important;
        color: #fff !important;
      }

      .table th,
      .table td {
        vertical-align: middle !important;
      }
      .table td {
        border-top: 1px solid #dee2e6;
      }
      .product-info {
        text-align: left;
  }
      .product-image {
        width: 70px;
        height: 70px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
      }
      .quantity-input {
        width: 60px;
      }
      .remove-btn {
        border: none;
        background: transparent;
        font-size: 1.5rem;
        color: crimson;
        cursor: pointer;
      }
      .remove-btn:hover {
        color: darkred;
      }

      /*update cart in small screens*/
      /* @media (max-width: 768px) {
        .d-image {
          display: flex;
          justify-content: center;
          align-items: center;
          margin-bottom: 10px;
        }
        .product-image {
          width: 160px;
          height: 160px;
          cursor: pointer;
          text-align: center;
        }

        .product-info {
          text-align: center;
        }

        .quantity-input {
          width: 50px !important;
          font-size: 14px;
          padding: 4px;
        }

        .table thead {
          display: none;
        }

        .table tr {
          display: block;
          margin-bottom: 15px;
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 10px;
        }

        .table td {
          display: flex;
          justify-content: center;
          align-items: center;
          border: none;
          padding: 6px 0;
        }

        .table td::before {
          content: attr(data-label);
          font-weight: bold;
          color: #284b63;
        }

        #cartActions {
          flex-direction: column;
          align-items: stretch;
        }

        #cartActions input {
          width: 100% !important;
          margin-bottom: 10px;
        }

        #cartActions .btn {
          width: 100%;
          margin-bottom: 10px;
        }

        .card {
          width: 100% !important;
        }
      } */


/* bootstrap */
.btn-outline{
  --bs-btn-color: black !important;
  --bs-btn-border-color:#284b63 !important;
  --bs-btn-hover-color:  #fff !important;
  --bs-btn-hover-bg:  #284b63 !important;
  --bs-btn-hover-border-color:  #284b63!important;
  --bs-btn-focus-shadow-rgb: 220,53,69;
  --bs-btn-active-color: #fff !important;
  --bs-btn-active-bg:  #284b63!important;
  --bs-btn-active-border-color:  #284b63 !important;
  --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
 
}

.btn-outline-secondary{
 --bs-btn-color:#a0804d !important;
  --bs-btn-border-color:#a0804d !important;
  --bs-btn-hover-color:  #fff !important;
  --bs-btn-hover-bg:  #284b63 !important;
  --bs-btn-hover-border-color:#284b63!important;
  --bs-btn-focus-shadow-rgb: 220,53,69;
  --bs-btn-active-color: #fff !important;
  --bs-btn-active-bg:#284b63 !important;
  --bs-btn-active-border-color:#284b63 !important;
  --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
}

    </style>
  </head>
  <body>
    <div id="navbar"></div>

    <!-- Navbar  -->
    <!-- <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom px-4">
    <a class="navbar-brand fw-bold" href="index.html">MyShop</a>
    <div class="ms-auto" style="font-size: 1.1rem; cursor: pointer;color: #284b63;">
      🛒 Cart (<span id="cart-count">0</span>)
    </div>
  </nav> --> 

    <!--cart content -->
    <div class="container min-vh-100 my-5">
      <!-- Breadcrumb -->
      <ul class="breadcrumb p-4">
       <li class="breadcrumb-item"><a href="index.html" class="small text-secondary text-decoration-none" >Home</a></li> 
       <li class="breadcrumb-item"><span class="active">Cart</span></li> 
 
        
      </ul>

      <div class="table-responsive">
        <table class="table align-middle text-center"> 
          <thead>
            <tr>
              <th style="color: #284b63">Product Image</th>
              <th style="color: #284b63">Product Name</th>
              <th style="color: #284b63">Price</th>
              <th style="width: 180px; color: #284b63">Quantity</th>
              <th style="color: #284b63">Subtotal</th>
              <th style="color: #284b63">Remove</th>
            </tr>
          </thead>
          <tbody id="cartItems" >
            <!-- add products -->
          </tbody>
        </table>
      </div>

      <div class="row mt-4" id="cartActions">
        <div
          class="col-12 d-flex justify-content-between align-items-center flex-wrap"
        >
          <div class="mb-3 mb-md-0 d-flex align-items-center justify-content-center justify-content-md-start col-12 col-md-6">
            <input
              type="text"
              id="coupon"
              class="form-control d-inline-block me-2 "
              style="width: 200px"
              placeholder="Coupon Code"
            />
            <button class="btn btn-outline" onclick="applyCoupon()">
              Apply Coupon
            </button>
          </div>
          <div class="d-flex flex-column flex-md-row align-items-center justify-content-center justify-content-md-end col-12 col-md-6 mt-5 mt-md-0" style="gap:10px">
            <button
              class="btn btn-outline  col-10 col-md-5 col-lg-auto mb-2 mb-md-0 "
              onclick="updateCart()"
            >
              Update Cart
            </button>
            <button class="btn border border-0  col-10 col-md-5 col-lg-auto mb-2 mb-md-0" style="background: #a0804d;color:#fff" onclick="continueShopping()">
              Continue Shopping
            </button>
          </div>
        </div>
      </div>

      <!--cart total -->
      <div class="d-flex justify-content-center justify-content-md-end mt-4 mt-5">
        <div class="card shadow-sm" style="max-width: 350px; width: 100% ">
          <div class="card-body">
            <h5 class="card-title" style="color: #284b63; font-weight: bolder">
              Cart Total
            </h5>
            <div class="d-flex justify-content-between">
              <span>Subtotal:</span>
              <strong>$<span id="subtotal">0.00</span></strong>
            </div>
            <div class="d-flex justify-content-between">
              <span>Shipping:</span>
              <strong><span style="color:green">Free</span></strong>
            </div>
            <hr />
            <div class="d-flex justify-content-between fs-5">
              <span>Total:</span>
              <strong>$<span id="total">0.00</span></strong>
            </div>
            <button class="btn border border-0 w-100 mt-3" style="background: #a0804d;color:#fff" onclick="goToCheckout()">
              Proceed to Checkout
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="footer" class="mt-5"></div>
    
    <script>
let cart = [];

// === Utilities to handle cart inside currentUser ===

// حفظ الكارت داخل currentUser
function saveCart(cart) {
  let currentUser = JSON.parse(localStorage.getItem("currentUser")) || null;
  if (currentUser) {
    currentUser.cart = cart;
    localStorage.setItem("currentUser", JSON.stringify(currentUser));
  }
}

// تحميل الكارت من currentUser
function loadCart() {
  let currentUser = JSON.parse(localStorage.getItem("currentUser")) || null;
  return (currentUser && currentUser.cart) ? currentUser.cart : [];
}

// تحديث عداد الكارت (لو عايزه في الـ navbar)
function updateCartCount() {
  let cart = loadCart();
  const count = cart.reduce((sum, item) => sum + item.quantity, 0);
  const counterEl = document.getElementById("cart-count");
  if (counterEl) counterEl.innerText = count;
}

// تحديث الكمية يدوي
function updateQty(id, qty) {
  let cart = loadCart();
  const index = cart.findIndex((p) => p.id === id);
  if (index !== -1) {
    let newQty = parseInt(qty);
    if (newQty > 0) {
      cart[index].quantity = newQty;
    } else {
      cart.splice(index, 1);
    }
    saveCart(cart);
    renderCart();
    updateCartCount();
  }
}

// تعديل الكمية بالأزرار + و -
function changeQuantity(id, newQty) {
  let cart = loadCart();
  const index = cart.findIndex((p) => p.id === id);
  if (index !== -1) {
    if (newQty <= 0) {
      cart.splice(index, 1);
    } else {
      cart[index].quantity = newQty;
    }
    saveCart(cart);
    renderCart();
    updateCartCount();
  }
}

// إزالة منتج من الكارت
// إزالة منتج من الكارت مع تحديث users
function removeItem(id) {
  if (confirm("Are you sure you want to remove this item from your cart?")) {
    // جلب currentUser و users
    let currentUser = JSON.parse(localStorage.getItem("currentUser")) || null;
    let users = JSON.parse(localStorage.getItem("users")) || [];

    if (currentUser && Array.isArray(currentUser.cart)) {
      // إزالة العنصر من cart الحالي
      currentUser.cart = currentUser.cart.filter((p) => p.id !== id);

      // تحديث users array
      const userIndex = users.findIndex(u => u.id === currentUser.id);
      if (userIndex !== -1) {
        users[userIndex] = currentUser;
      }

      // حفظ التحديثات في localStorage
      localStorage.setItem("currentUser", JSON.stringify(currentUser));
      localStorage.setItem("users", JSON.stringify(users));
    }

    // إعادة عرض الكارت وعداد الكارت
    renderCart();
    updateCartCount();
  }
}


// عرض الكارت
function renderCart() {
  cart = loadCart();
  const cartItemsContainer = document.getElementById("cartItems");
  let rows = "";
  let subtotal = 0;

  if (cart.length === 0) {
    document.getElementById("cartActions").style.display = "none";
    rows = `
      <tr>
        <td colspan="5" class="text-center py-5">
          <div class="text-muted">
            <div style="font-size: 3rem;">🛒</div>
            <h4 class="mt-3">Your cart is empty</h4>
            <p>Add some products to get started!</p>
            <button class="btn btn-outline-secondary" onclick="continueShopping()">Start Shopping</button>
          </div>
        </td>
      </tr>
    `;
  } else {
    document.getElementById("cartActions").style.display = "flex";
    cart.forEach((item) => {
      const itemSubtotal = item.price * item.quantity;
      subtotal += itemSubtotal;

      rows += `
        <tr>
          <td style="width: 300px;" class="align-middle">
            <div class="d-flex align-items-center justify-content-center d-image">
              <img src="../assets/${item.images}" 
                   alt="${item.name}" 
                   class="product-image me-3"
                   onclick="goToProductDetails('${item.id}')"
                   onerror="this.src='../assets/images/placeholder.jpg'">
            </div>
          </td>
          <td class="product-info">
            <div>
              <h6 class="mb-1" style="color:#284b63">${item.name}</h6>
              <small class="text-muted" style="color:#284b63">Product ID: ${item.id}</small>
            </div>
          </td>
          <td><strong class="text-danger">$${item.price.toFixed(2)}</strong></td>
          <td>
            <div class="d-flex justify-content-center align-items-center">
              <button class="btn btn-sm btn-outline-secondary" onclick="changeQuantity('${item.id}', ${item.quantity - 1})">-</button>
              <input type="number" min="1" value="${item.quantity}" 
                     class="form-control quantity-input mx-2 text-center"
                     onchange="updateQty('${item.id}', this.value)">
              <button class="btn btn-sm btn-outline-secondary" onclick="changeQuantity('${item.id}', ${item.quantity + 1})">+</button>
            </div>
          </td>
          <td><strong style="color:#284b63">$${itemSubtotal.toFixed(2)}</strong></td>
          <td><button class="remove-btn" onclick="removeItem('${item.id}')"><i class="fa-solid fa-trash" style="font-size:16px"></i></button></td>
        </tr>
      `;
    });
  }

  cartItemsContainer.innerHTML = rows;
  document.getElementById("subtotal").innerText = subtotal.toFixed(2);
  document.getElementById("total").innerText = subtotal.toFixed(2);
}

// الانتقال لتفاصيل المنتج
function goToProductDetails(productId) {
  window.location.href = `product-details.html?id=${productId}`;
}

// الذهاب لصفحة الدفع
function goToCheckout() {
  if (loadCart().length === 0) {
    alert("Your cart is empty! Add some products first.");
    return;
  }
  window.location.href = "checkout.html";
}

// تحديث الكارت
function updateCart() {
  renderCart();
  alert("Cart updated successfully!");
}

// تطبيق كوبون (placeholder)
function applyCoupon() {
  const couponCode = document.getElementById("coupon").value.trim();
  if (couponCode) {
    alert("Coupon functionality will be implemented soon!");
  } else {
    alert("Please enter a coupon code");
  }
}

// استكمال التسوق
function continueShopping() {
  window.location.href = "index.html";
}

// عند تحميل الصفحة
document.addEventListener("DOMContentLoaded", () => {
  renderCart();
  updateCartCount();

  // تحميل الـ navbar
  fetch("partials/navbar.html")
    .then((res) => res.text())
    .then((data) => {
      document.getElementById("navbar").innerHTML = data;
    })
    .catch((err) => console.error("Error loading navbar:", err));

  // تحميل الـ footer
  fetch("partials/footer.html")
    .then((res) => res.text())
    .then((data) => {
      document.getElementById("footer").innerHTML = data;
    })
    .catch((err) => console.error("Error loading footer:", err));
});
</script>

    <script src="js/components.js"></script>
  </body>
</html>
